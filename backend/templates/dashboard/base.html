{% extends "base.html" %}

{% block body %}
<div class="min-h-screen" x-data="chatState()" x-init="initChat()">
    <!-- Mobile sidebar backdrop -->
    <div
        x-show="sidebarOpen"
        x-cloak
        @click="sidebarOpen = false"
        class="fixed inset-0 z-40 bg-black/50 lg:hidden"
    ></div>

    <!-- Sidebar -->
    <aside
        :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transition-transform lg:translate-x-0"
    >
        <div class="flex h-full flex-col">
            <!-- Logo -->
            <div class="flex h-16 items-center justify-between px-6 border-b">
                <h1 class="text-lg font-bold text-primary-600">Turbine Turmweg</h1>
                <button @click="sidebarOpen = false" class="lg:hidden">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 space-y-1 px-3 py-4">
                <a href="/training" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium {% if active_page == 'training' %}bg-primary-50 text-primary-700{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Training
                </a>
                <a href="/activities" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium {% if active_page == 'activities' %}bg-primary-50 text-primary-700{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Activities
                </a>
                <a href="/competitions" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium {% if active_page == 'competitions' %}bg-primary-50 text-primary-700{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                    Competitions
                </a>
                <a href="/settings" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium {% if active_page == 'settings' %}bg-primary-50 text-primary-700{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Settings
                </a>
            </nav>

            <!-- User section -->
            <div class="border-t p-4">
                <div class="flex items-center gap-3 mb-3">
                    <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center">
                        <span class="text-sm font-medium text-primary-700">{{ user.name[0]|upper }}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate">{{ user.name }}</p>
                        <p class="text-xs text-gray-500 truncate">{{ user.email }}</p>
                    </div>
                </div>
                <a href="/logout" class="flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    Sign out
                </a>
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <div class="lg:pl-64">
        <!-- Top bar -->
        <header class="sticky top-0 z-30 flex h-16 items-center gap-4 border-b bg-white px-4 lg:px-6">
            <button @click="sidebarOpen = true" class="lg:hidden">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <div class="flex-1"></div>
            {% if user.strava_athlete_id %}
            <span class="text-xs text-gray-500 flex items-center gap-1">
                <span class="h-2 w-2 rounded-full bg-green-500"></span>
                Strava connected
            </span>
            {% else %}
            <a href="/settings" class="text-xs text-primary-600 hover:text-primary-700">Connect Strava</a>
            {% endif %}
        </header>

        <!-- Page content -->
        <main class="p-4 lg:p-6">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- AI Chat Button (fixed position) -->
    <button
        @click="chatOpen = !chatOpen"
        class="fixed bottom-6 right-6 z-40 p-4 bg-primary-600 text-white rounded-full shadow-lg hover:bg-primary-700 transition-colors"
        title="AI Training Coach"
    >
        <svg x-show="!chatOpen" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
        </svg>
        <svg x-show="chatOpen" x-cloak class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </button>

    <!-- AI Chat Panel -->
    <div
        x-show="chatOpen"
        x-cloak
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="translate-x-full"
        class="fixed inset-y-0 right-0 z-50 w-full sm:w-96 bg-white shadow-xl flex flex-col"
    >
        <!-- Chat header -->
        <div class="flex items-center justify-between px-4 py-3 border-b bg-primary-600 text-white">
            <div class="flex items-center gap-2">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                <span class="font-medium">Turbi - AI Coach</span>
            </div>
            <div class="flex items-center gap-1">
                <button @click="clearChat()" class="p-1 hover:bg-primary-700 rounded" title="Clear chat history">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                <button @click="chatOpen = false" class="p-1 hover:bg-primary-700 rounded" title="Close">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Welcome message -->
            <template x-if="chatMessages.length === 0">
                <div class="text-center text-gray-500 py-8">
                    <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                    </svg>
                    <p class="text-sm">Hi! I'm Turbi, your AI coach.</p>
                    <p class="text-xs mt-1">Ask me to adjust workouts, provide feedback, or help with your training plan.</p>
                </div>
            </template>

            <!-- Messages -->
            <template x-for="(msg, index) in chatMessages" :key="index">
                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="msg.role === 'user' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-900'"
                         class="max-w-[80%] rounded-lg px-4 py-2 text-sm">
                        <div class="chat-markdown" x-html="renderMarkdown(msg.content)"></div>
                    </div>
                </div>
            </template>

            <!-- Loading indicator -->
            <div x-show="chatLoading" class="flex justify-start">
                <div class="bg-gray-100 rounded-lg px-4 py-2">
                    <div class="flex items-center gap-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat input -->
        <div class="border-t p-4">
            <form @submit.prevent="sendMessage()" class="flex gap-2">
                <textarea
                    x-model="chatInput"
                    @keydown.enter.prevent="if (!$event.shiftKey) { sendMessage(); }"
                    placeholder="Ask about your training... (Shift+Enter for new line)"
                    rows="2"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm resize-none"
                    :disabled="chatLoading"
                ></textarea>
                <button
                    type="submit"
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed self-end"
                    :disabled="chatLoading || !chatInput.trim()"
                >
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </form>
            <p class="text-xs text-gray-400 mt-2">Enter to send, Shift+Enter for new line</p>
        </div>
    </div>

    <!-- Chat backdrop for mobile -->
    <div
        x-show="chatOpen"
        x-cloak
        @click="chatOpen = false"
        class="fixed inset-0 z-40 bg-black/50 sm:hidden"
    ></div>
</div>

<script>
// Chat state management with sessionStorage persistence
function chatState() {
    return {
        sidebarOpen: false,
        chatOpen: false,
        chatMessages: [],
        chatInput: '',
        chatLoading: false,

        initChat() {
            // Restore chat state from sessionStorage
            const savedMessages = sessionStorage.getItem('chatMessages');
            const savedOpen = sessionStorage.getItem('chatOpen');

            if (savedMessages) {
                try {
                    this.chatMessages = JSON.parse(savedMessages);
                } catch (e) {
                    this.chatMessages = [];
                }
            }
            if (savedOpen === 'true') {
                this.chatOpen = true;
            }

            // Watch for changes and persist
            this.$watch('chatMessages', (value) => {
                sessionStorage.setItem('chatMessages', JSON.stringify(value));
            });
            this.$watch('chatOpen', (value) => {
                sessionStorage.setItem('chatOpen', value ? 'true' : 'false');
            });
        },

        clearChat() {
            this.chatMessages = [];
            sessionStorage.removeItem('chatMessages');
        },

        async sendMessage() {
            const input = this.chatInput.trim();
            if (!input || this.chatLoading) return;

            // Add user message
            this.chatMessages.push({ role: 'user', content: input });
            this.chatInput = '';
            this.chatLoading = true;

            // Scroll to bottom
            this.scrollToBottom();

            try {
                const response = await fetch('/api/chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: this.chatMessages,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const result = await response.json();
                this.chatMessages.push({
                    role: 'assistant',
                    content: result.message.content
                });

                // Check if any tools modified data (session created/updated)
                if (result.tool_results && result.tool_results.length > 0) {
                    const modifyingTools = ['update_session_workout', 'create_session'];
                    const hasModification = result.tool_results.some(
                        tr => modifyingTools.includes(tr.tool)
                    );
                    if (hasModification) {
                        // Show a subtle notification that data was changed
                        this.chatMessages.push({
                            role: 'assistant',
                            content: '(Training plan updated - refresh the page to see changes)'
                        });
                    }
                }
            } catch (error) {
                this.chatMessages.push({
                    role: 'assistant',
                    content: 'Sorry, I encountered an error. Please try again.'
                });
            } finally {
                this.chatLoading = false;
                this.scrollToBottom();
            }
        },

        scrollToBottom() {
            setTimeout(() => {
                const container = document.getElementById('chat-messages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 50);
        },

        renderMarkdown(content) {
            if (!content) return '';
            // Use marked.js if available, otherwise fall back to simple newline replacement
            if (typeof marked !== 'undefined') {
                try {
                    return marked.parse(content);
                } catch (e) {
                    return content.replace(/\n/g, '<br>');
                }
            }
            return content.replace(/\n/g, '<br>');
        }
    };
}

// Legacy function for backwards compatibility
async function sendChatMessage() {
    const data = Alpine.$data(document.querySelector('[x-data]'));
    if (data && data.sendMessage) {
        await data.sendMessage();
    }
}

window.sendChatMessage = sendChatMessage;
</script>
{% endblock %}
