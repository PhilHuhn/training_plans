<div id="training-week" class="space-y-4">
    {% for day in week_days %}
    {% set session = sessions_by_date.get(day.strftime('%Y-%m-%d')) %}
    {% set is_today = day.strftime('%Y-%m-%d') == today %}
    <div class="bg-white rounded-lg shadow {% if is_today %}ring-2 ring-primary-500{% endif %}">
        <div class="px-4 py-3 border-b flex items-center justify-between">
            <h3 class="font-medium text-gray-900">
                {{ day.strftime('%A, %b %d') }}
                {% if is_today %}
                <span class="ml-2 text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded">Today</span>
                {% endif %}
            </h3>
            <div class="flex items-center gap-2">
                {% if session and session.status.value == 'completed' %}
                <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Completed</span>
                {% endif %}
                {% if session %}
                <button
                    hx-delete="/api/training/sessions/{{ session.id }}"
                    hx-confirm="Delete this session?"
                    class="p-1 text-gray-400 hover:text-red-500"
                    title="Delete session"
                >
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                {% endif %}
            </div>
        </div>
        <div class="p-4 grid md:grid-cols-3 gap-4">
            <!-- Column 1: Manual/Planned workout -->
            <div>
                <p class="text-xs font-medium text-blue-600 uppercase tracking-wide mb-2 md:hidden">Manual Plan</p>
                {% if session and session.planned_workout %}
                <div class="border border-blue-200 rounded-md p-3 space-y-2 bg-blue-50 relative workout-card" data-workout='{{ session.planned_workout|tojson|e }}' data-session-id="{{ session.id }}" data-date="{{ day.strftime('%Y-%m-%d') }}">
                    <!-- Top row with edit button, type badge, and accept button -->
                    <div class="flex items-center gap-2">
                        <button
                            onclick="openSessionModalFromCard(this)"
                            class="p-1 text-blue-400 hover:text-blue-600 hover:bg-blue-100 rounded flex-shrink-0"
                            title="Edit planned session"
                        >
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700">{{ session.planned_workout.type|replace('_', ' ')|title }}</span>
                        {% if session.planned_workout.intensity %}
                        <span class="text-xs text-gray-500">{{ session.planned_workout.intensity }}</span>
                        {% endif %}
                        <div class="ml-auto flex-shrink-0">
                            {% if session.accepted_source is none or session.accepted_source != 'planned' %}
                            <button
                                hx-post="/api/training/sessions/{{ session.id }}/accept?source=planned"
                                class="p-1 text-blue-600 hover:bg-blue-100 rounded"
                                title="Accept this workout"
                            >
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                            {% else %}
                            <span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded">Accepted</span>
                            {% endif %}
                        </div>
                    </div>
                    <p class="text-sm text-gray-700">{{ session.planned_workout.description }}</p>
                    <div class="flex flex-wrap gap-2 text-xs text-gray-500">
                        {% if session.planned_workout.distance_km %}
                        <span>{{ session.planned_workout.distance_km }} km</span>
                        {% endif %}
                        {% if session.planned_workout.duration_min %}
                        <span>{{ session.planned_workout.duration_min }} min</span>
                        {% endif %}
                        {% if session.planned_workout.pace_range %}
                        <span>{{ session.planned_workout.pace_range }}/km</span>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <button
                    onclick="openSessionModal('{{ day.strftime('%Y-%m-%d') }}', {{ session.id if session else 'null' }}, null)"
                    class="w-full border border-dashed border-gray-300 rounded-md p-4 text-center text-sm text-gray-400 h-24 flex items-center justify-center hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-colors"
                    title="Add planned session"
                >
                    <span class="flex items-center gap-1">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add workout
                    </span>
                </button>
                {% endif %}
            </div>

            <!-- Column 2: AI Recommendation -->
            <div>
                <p class="text-xs font-medium text-purple-600 uppercase tracking-wide mb-2 flex items-center gap-1 md:hidden">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                    AI Recommendation
                </p>
                {% if session and session.recommendation_workout %}
                <div class="border border-purple-200 rounded-md p-3 space-y-2 bg-purple-50 relative">
                    <div class="flex items-center gap-2">
                        <span class="text-xs px-2 py-0.5 rounded bg-purple-100 text-purple-700">{{ session.recommendation_workout.type|replace('_', ' ')|title }}</span>
                        {% if session.recommendation_workout.intensity %}
                        <span class="text-xs text-gray-500">{{ session.recommendation_workout.intensity }}</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-gray-700">{{ session.recommendation_workout.description }}</p>
                    <div class="flex flex-wrap gap-2 text-xs text-gray-500">
                        {% if session.recommendation_workout.distance_km %}
                        <span>{{ session.recommendation_workout.distance_km }} km</span>
                        {% endif %}
                        {% if session.recommendation_workout.duration_min %}
                        <span>{{ session.recommendation_workout.duration_min }} min</span>
                        {% endif %}
                        {% if session.recommendation_workout.pace_range %}
                        <span>{{ session.recommendation_workout.pace_range }}/km</span>
                        {% endif %}
                    </div>
                    <!-- Accept button -->
                    {% if session and (session.accepted_source is none or session.accepted_source != 'ai') %}
                    <button
                        hx-post="/api/training/sessions/{{ session.id }}/accept?source=ai"
                        class="absolute top-2 right-2 p-1 text-purple-600 hover:bg-purple-100 rounded"
                        title="Accept this workout"
                    >
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                    {% endif %}
                    {% if session and session.accepted_source and session.accepted_source == 'ai' %}
                    <div class="absolute top-2 right-2">
                        <span class="text-xs bg-purple-600 text-white px-2 py-0.5 rounded">Accepted</span>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="border border-dashed border-gray-300 rounded-md p-4 text-center text-sm text-gray-400 h-24 flex items-center justify-center">
                    No recommendation yet
                </div>
                {% endif %}
            </div>

            <!-- Column 3: Final Plan -->
            <div>
                <p class="text-xs font-medium text-primary-600 uppercase tracking-wide mb-2 md:hidden">Final Plan</p>
                {% if session and session.final_workout %}
                <div class="border-2 border-primary-500 rounded-md p-3 space-y-2 bg-primary-50 relative">
                    <div class="flex items-center gap-2">
                        <span class="text-xs px-2 py-0.5 rounded bg-primary-100 text-primary-700">{{ session.final_workout.type|replace('_', ' ')|title }}</span>
                        {% if session.final_workout.intensity %}
                        <span class="text-xs text-gray-500">{{ session.final_workout.intensity }}</span>
                        {% endif %}
                        <span class="text-xs text-primary-600 ml-auto">
                            {% if session.accepted_source and session.accepted_source == 'planned' %}
                            from Manual
                            {% elif session.accepted_source and session.accepted_source == 'ai' %}
                            from AI
                            {% endif %}
                        </span>
                        <!-- Export to Garmin button -->
                        <a href="/api/training/sessions/{{ session.id }}/export/garmin"
                           class="p-1 text-primary-600 hover:bg-primary-100 rounded"
                           title="Export to Garmin (.fit file)"
                           download>
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                        </a>
                    </div>
                    <p class="text-sm text-gray-700">{{ session.final_workout.description }}</p>
                    <div class="flex flex-wrap gap-2 text-xs text-gray-500">
                        {% if session.final_workout.distance_km %}
                        <span class="font-medium">{{ session.final_workout.distance_km }} km</span>
                        {% endif %}
                        {% if session.final_workout.duration_min %}
                        <span>{{ session.final_workout.duration_min }} min</span>
                        {% endif %}
                        {% if session.final_workout.hr_zone %}
                        <span>HR: {{ session.final_workout.hr_zone }}</span>
                        {% endif %}
                        {% if session.final_workout.pace_range %}
                        <span>{{ session.final_workout.pace_range }}/km</span>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="border border-dashed border-gray-300 rounded-md p-4 text-center text-sm text-gray-400 h-24 flex items-center justify-center">
                    <span>Accept a workout<br>from Manual or AI</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
